#include BleKeyboard.h

BleKeyboard bleKeyboard(ESP32 Media Pad, DIY, 100);

#define ENC_CLK 25 
#define ENC_DT  26
#define ENC_SW  27

int lastCLK;

 ==== CLICK LOGIC ====
unsigned long lastClickTime = 0;
int clickCount = 0;
const unsigned long clickDelay = 400;  thời gian chờ để gom click (ms)

void setup() {
  Serial.begin(115200);

  pinMode(ENC_CLK, INPUT_PULLUP);
  pinMode(ENC_DT, INPUT_PULLUP);
  pinMode(ENC_SW, INPUT_PULLUP);

  lastCLK = digitalRead(ENC_CLK);

  bleKeyboard.begin();
}

void loop() {

  if (!bleKeyboard.isConnected()) return;

   ===== XOAY → VOLUME =====
  int currentCLK = digitalRead(ENC_CLK);

  if (currentCLK != lastCLK && currentCLK == LOW) {

    if (digitalRead(ENC_DT) != currentCLK)
      bleKeyboard.write(KEY_MEDIA_VOLUME_UP);
    else
      bleKeyboard.write(KEY_MEDIA_VOLUME_DOWN);
  }

  lastCLK = currentCLK;

   ===== NÚT NHẤN ĐA CLICK =====
  static bool lastBtn = HIGH;
  bool btn = digitalRead(ENC_SW);

  if (btn == LOW && lastBtn == HIGH) {
    clickCount++;
    lastClickTime = millis();
  }

  lastBtn = btn;

   Nếu hết thời gian gom click → xử lý
  if (clickCount  0 && millis() - lastClickTime  clickDelay) {

    if (clickCount == 1) {
      bleKeyboard.write(KEY_MEDIA_PLAY_PAUSE);
    }
    else if (clickCount == 2) {
      bleKeyboard.write(KEY_MEDIA_NEXT_TRACK);
    }
    else if (clickCount = 3) {
      bleKeyboard.write(KEY_MEDIA_PREVIOUS_TRACK);
    }

    clickCount = 0;
  }
}
